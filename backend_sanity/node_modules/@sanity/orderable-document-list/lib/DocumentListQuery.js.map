{"version":3,"file":"DocumentListQuery.js","names":["client","sanityClient","withConfig","apiVersion","DocumentListQuery","type","filter","params","useState","isLoading","setIsLoading","listIsUpdating","setListIsUpdating","data","setData","useEffect","query","ORDER_FIELD_NAME","queryParams","Object","assign","order","subscription","fetchData","fetch","then","documents","filteredDocuments","reduce","acc","cur","_id","startsWith","alsoHasDraft","some","doc","prepareData","listen","subscribe","length","unsubscribe","unorderedDataCount","useMemo","width","height","overflow","propTypes","PropTypes","string","isRequired","object","defaultProps"],"sources":["../src/DocumentListQuery.js"],"sourcesContent":["import PropTypes from 'prop-types'\nimport React, {useEffect, useState, useMemo} from 'react'\nimport sanityClient from 'part:@sanity/base/client'\nimport {Stack, Box, Flex, Spinner} from '@sanity/ui'\n\nimport DraggableList from './DraggableList'\nimport {ORDER_FIELD_NAME} from './helpers/constants'\nimport Feedback from './Feedback'\n\nconst client = sanityClient.withConfig({\n  apiVersion: '2021-09-01',\n})\n\nexport default function DocumentListQuery({type, filter, params}) {\n  const [isLoading, setIsLoading] = useState(true)\n  const [listIsUpdating, setListIsUpdating] = useState(false)\n  const [data, setData] = useState([])\n\n  useEffect(() => {\n    const query = `*[_type == $type ${filter ? `&& ${filter}` : ''}]|order(@[$order] asc){\n      _id, _type, ${ORDER_FIELD_NAME}\n    }`\n    const queryParams = Object.assign(params, {type, order: ORDER_FIELD_NAME})\n    let subscription = null\n\n    // eslint-disable-next-line require-await\n    const fetchData = async () => {\n      client.fetch(query, queryParams).then((documents) => {\n        // Remove published document from list if draft also exists\n        const filteredDocuments = documents.reduce((acc, cur) => {\n          if (!cur._id.startsWith(`drafts.`)) {\n            // eslint-disable-next-line max-nested-callbacks\n            const alsoHasDraft = documents.some((doc) => doc._id === `drafts.${cur._id}`)\n\n            return alsoHasDraft ? acc : [...acc, cur]\n          }\n\n          return [...acc, cur]\n        }, [])\n\n        setData(filteredDocuments)\n\n        if (isLoading) {\n          setIsLoading(false)\n        }\n      })\n    }\n\n    const prepareData = async () => {\n      setIsLoading(true)\n\n      await fetchData()\n\n      if (!subscription) {\n        subscription = client.listen(query, queryParams).subscribe(() => fetchData())\n      }\n    }\n\n    // Get data but only if a document isn't being patched or we don't yet have data\n    if (!listIsUpdating && !data.length) {\n      prepareData()\n    }\n\n    return () => subscription?.unsubscribe()\n    /* eslint-disable-next-line react-hooks/exhaustive-deps */\n  }, [type])\n\n  const unorderedDataCount = useMemo(\n    () => (data.length ? data.filter((doc) => !doc[ORDER_FIELD_NAME]).length : 0),\n    [data]\n  )\n\n  if (isLoading)\n    return (\n      <Flex style={{width: `100%`, height: `100%`}} align=\"center\" justify=\"center\">\n        <Spinner />\n      </Flex>\n    )\n\n  return (\n    <Stack space={1} style={{overflow: `scroll`, height: `100%`}}>\n      {unorderedDataCount > 0 && (\n        <Feedback>\n          {unorderedDataCount}/{data.length} Documents have no Order. Select{' '}\n          <strong>Reset Order</strong> from the Menu above to fix.\n        </Feedback>\n      )}\n      <Box padding={1}>\n        <DraggableList\n          data={data}\n          type={type}\n          listIsUpdating={listIsUpdating}\n          setListIsUpdating={setListIsUpdating}\n        />\n      </Box>\n    </Stack>\n  )\n}\n\nDocumentListQuery.propTypes = {\n  type: PropTypes.string.isRequired,\n  filter: PropTypes.string,\n  params: PropTypes.object,\n}\n\nDocumentListQuery.defaultProps = {\n  filter: ``,\n  params: {},\n}\n"],"mappings":"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"}